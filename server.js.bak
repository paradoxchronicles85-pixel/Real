
const http = require('http');
const fs = require('fs');
const path = require('path');

const PORT = 5000;

// In-memory storage (replace with proper DB later)
const users = new Map();
const coupons = new Map([
    ['WELCOME20', { discount: 20, validForPlan: 'lite' }],
    ['PREMIUM50', { discount: 50, validForPlan: 'premium' }],
    ['STANDARD30', { discount: 30, validForPlan: 'standard' }],
    ['BUSINESS40', { discount: 40, validForPlan: 'bg' }]
]);

const ADMIN_PHONES = ['+13124202900'];
const VENDOR_PHONES = [
    '+2347084174994', '+2347040759259', '+2348143662936',
    '+2347044035084', '+2347089902875', '+2347048787493',
    '+2349163483144', '+2349046428186', '+2347071401650'
];

const mimeTypes = {
    '.html': 'text/html',
    '.css': 'text/css',
    '.js': 'application/javascript',
    '.json': 'application/json',
    '.png': 'image/png',
    '.jpg': 'image/jpeg',
    '.jpeg': 'image/jpeg',
    '.gif': 'image/gif',
    '.svg': 'image/svg+xml',
    '.ico': 'image/x-icon'
};

function parseBody(req) {
    return new Promise((resolve, reject) => {
        let body = '';
        req.on('data', chunk => body += chunk.toString());
        req.on('end', () => {
            try {
                resolve(JSON.parse(body));
            } catch (e) {
                reject(e);
            }
        });
        req.on('error', reject);
    });
}

function sendJSON(res, statusCode, data) {
    res.writeHead(statusCode, { 
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*'
    });
    res.end(JSON.stringify(data));
}

const server = http.createServer(async (req, res) => {
    // API Routes
    if (req.url.startsWith('/api/')) {
        try {
            if (req.url === '/api/config' && req.method === 'GET') {
                sendJSON(res, 200, { adminPhones: ADMIN_PHONES, vendorPhones: VENDOR_PHONES });
                return;
            }

            if (req.url === '/api/validate-coupon' && req.method === 'POST') {
                const { code, plan } = await parseBody(req);
                const coupon = coupons.get(code);
                
                if (!coupon) {
                    sendJSON(res, 200, { valid: false, error: 'Invalid coupon code' });
                    return;
                }

                if (coupon.validForPlan !== plan) {
                    sendJSON(res, 200, { 
                        valid: false, 
                        error: 'Coupon not valid for this plan',
                        validPlan: coupon.validForPlan 
                    });
                    return;
                }

                sendJSON(res, 200, { valid: true, discount: coupon.discount });
                return;
            }

            if (req.url === '/api/signup' && req.method === 'POST') {
                const data = await parseBody(req);
                
                // Validation
                if (!data.email || !data.password || !data.fullname || !data.phone) {
                    sendJSON(res, 400, { success: false, error: 'Missing required fields' });
                    return;
                }

                // Check for duplicate email
                if (users.has(data.email)) {
                    sendJSON(res, 400, { success: false, error: 'Email already registered' });
                    return;
                }

                // Check for duplicate phone number
                for (const [email, user] of users.entries()) {
                    if (user.phone === data.phone) {
                        sendJSON(res, 400, { success: false, error: 'Phone number already registered' });
                        return;
                    }
                }

                // Store user (in production, hash password!)
                users.set(data.email, {
                    fullname: data.fullname,
                    email: data.email,
                    phone: data.phone,
                    plan: data.plan,
                    userType: data.userType,
                    createdAt: new Date().toISOString()
                });

                sendJSON(res, 200, { 
                    success: true, 
                    message: 'Account created successfully',
                    user: { fullname: data.fullname, email: data.email, plan: data.plan }
                });
                return;
            }

            if (req.url === '/api/login' && req.method === 'POST') {
                const { email, password } = await parseBody(req);
                
                const user = users.get(email);
                if (!user) {
                    sendJSON(res, 401, { success: false, error: 'Invalid credentials' });
                    return;
                }

                sendJSON(res, 200, { 
                    success: true, 
                    message: 'Login successful',
                    user: { fullname: user.fullname, email: user.email, plan: user.plan },
                    redirectTo: '/dashboard.html'
                });
                return;
            }

            sendJSON(res, 404, { error: 'API endpoint not found' });
        } catch (error) {
            console.error('API Error:', error);
            sendJSON(res, 500, { error: 'Server error' });
        }
        return;
    }

    // Static file serving
    let filePath = '.' + req.url;
    if (filePath === './') {
        filePath = './index.html';
    }

    const extname = String(path.extname(filePath)).toLowerCase();
    const contentType = mimeTypes[extname] || 'application/octet-stream';

    fs.readFile(filePath, (error, content) => {
        if (error) {
            if (error.code === 'ENOENT') {
                res.writeHead(404, { 'Content-Type': 'text/html' });
                res.end('<h1>404 - File Not Found</h1>', 'utf-8');
            } else {
                res.writeHead(500);
                res.end('500 - Server Error: ' + error.code);
            }
        } else {
            res.writeHead(200, { 
                'Content-Type': contentType,
                'Cache-Control': 'no-cache'
            });
            res.end(content, 'utf-8');
        }
    });
});

server.listen(PORT, '0.0.0.0', () => {
    console.log(`ðŸŒŸ Paradox Server running at http://0.0.0.0:${PORT}/`);
    console.log(`âœ¨ Divine prosperity awaits...`);
    console.log(`ðŸ“¡ API endpoints active`);
});
